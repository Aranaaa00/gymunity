<form class="formulario-perfil" [formGroup]="perfilForm" (ngSubmit)="onSubmit()">
  <fieldset class="formulario-perfil__seccion">
    <legend class="formulario-perfil__titulo">Información personal</legend>

    <section class="formulario-perfil__grupo">
      <app-campo-formulario
        label="Nombre"
        type="text"
        placeholder="Tu nombre"
        inputId="perfil-nombre"
        name="nombre"
        [formControl]="getControl('nombre')"
        [required]="true"
        helpText="Entre 2 y 50 caracteres."
        [hasError]="getControl('nombre').touched && getControl('nombre').invalid"
        [errorMessage]="getErrorMessage('nombre')">
      </app-campo-formulario>

      <app-campo-formulario
        label="Apellidos"
        type="text"
        placeholder="Tus apellidos"
        inputId="perfil-apellidos"
        name="apellidos"
        [formControl]="getControl('apellidos')"
        [required]="true"
        helpText="Entre 2 y 50 caracteres."
        [hasError]="getControl('apellidos').touched && getControl('apellidos').invalid"
        [errorMessage]="getErrorMessage('apellidos')">
      </app-campo-formulario>
    </section>

    <app-campo-formulario
      label="Nombre de usuario"
      type="text"
      placeholder="tu_usuario"
      inputId="perfil-username"
      name="username"
      [formControl]="getControl('username')"
      [required]="true"
      helpText="Entre 3 y 20 caracteres. Solo letras, números y guión bajo."
      [validando]="estaValidando('username')"
      [hasError]="getControl('username').touched && getControl('username').invalid"
      [errorMessage]="getErrorMessage('username')"
      [mensajeExito]="getMensajeExito('username')">
    </app-campo-formulario>

    <app-campo-formulario
      label="Email"
      type="email"
      placeholder="tu@email.com"
      inputId="perfil-email"
      name="email"
      [formControl]="getControl('email')"
      [required]="true"
      helpText="El email no se puede modificar."
      [hasError]="getControl('email').touched && getControl('email').invalid"
      [errorMessage]="getErrorMessage('email')">
    </app-campo-formulario>
  </fieldset>

  <fieldset class="formulario-perfil__seccion">
    <legend class="formulario-perfil__titulo">Contacto</legend>

    <section class="formulario-perfil__grupo">
      <app-campo-formulario
        label="Teléfono"
        type="tel"
        placeholder="600123456"
        inputId="perfil-telefono"
        name="telefono"
        [formControl]="getControl('telefono')"
        helpText="Formato español: 600123456 o +34 600 123 456."
        [hasError]="getControl('telefono').touched && getControl('telefono').invalid"
        [errorMessage]="getErrorMessage('telefono')">
      </app-campo-formulario>

      <app-campo-formulario
        label="Código Postal"
        type="text"
        placeholder="28001"
        inputId="perfil-codigoPostal"
        name="codigoPostal"
        [formControl]="getControl('codigoPostal')"
        helpText="5 dígitos. Ejemplo: 28001."
        [hasError]="getControl('codigoPostal').touched && getControl('codigoPostal').invalid"
        [errorMessage]="getErrorMessage('codigoPostal')">
      </app-campo-formulario>
    </section>
  </fieldset>

  <fieldset class="formulario-perfil__seccion">
    <legend class="formulario-perfil__titulo">Biografía</legend>

    <app-area-texto
      label="Cuéntanos sobre ti"
      placeholder="Escribe una breve descripción..."
      inputId="perfil-bio"
      name="bio"
      [formControl]="getControl('bio')"
      helpText="Máximo 500 caracteres."
      [maxlength]="500"
      [hasError]="getControl('bio').touched && getControl('bio').invalid"
      [errorMessage]="getErrorMessage('bio')">
    </app-area-texto>
  </fieldset>

  <fieldset class="formulario-perfil__seccion">
    <legend class="formulario-perfil__titulo">Redes sociales</legend>

    <section class="formulario-perfil__redes" formArrayName="redesSociales">
      @for (redControl of redesSocialesArray.controls; track $index) {
        <article class="formulario-perfil__red" [formGroupName]="$index">
          <section class="formulario-perfil__red-campos">
            <section class="formulario-perfil__campo-selector">
              <label [for]="'red-plataforma-' + $index" class="sr-only">Plataforma</label>
              <select 
                [id]="'red-plataforma-' + $index" 
                [formControl]="getRedSocialControl($index, 'plataforma')"
                [attr.aria-invalid]="getRedSocialControl($index, 'plataforma').touched && getRedSocialControl($index, 'plataforma').invalid || null"
                [attr.aria-describedby]="getRedSocialControl($index, 'plataforma').touched && getRedSocialControl($index, 'plataforma').invalid ? 'error-plataforma-' + $index : null"
                aria-required="true">
                @for (plataforma of plataformasDisponibles; track plataforma) {
                  <option [value]="plataforma">{{ plataforma }}</option>
                }
              </select>
              @if (getRedSocialControl($index, 'plataforma').touched && getRedSocialControl($index, 'plataforma').invalid) {
                <small class="error" [id]="'error-plataforma-' + $index" role="alert">{{ getErrorMessageRedSocial($index, 'plataforma') }}</small>
              }
            </section>

            <app-campo-formulario
              label="URL"
              type="url"
              placeholder="https://..."
              inputId="red-url-{{$index}}"
              name="url-{{$index}}"
              [formControl]="getRedSocialControl($index, 'url')"
              [required]="true"
              helpText="URL completa. Ejemplo: https://instagram.com/tu_perfil"
              [hasError]="getRedSocialControl($index, 'url').touched && getRedSocialControl($index, 'url').invalid"
              [errorMessage]="getErrorMessageRedSocial($index, 'url')">
            </app-campo-formulario>
          </section>

          <button
            type="button"
            class="formulario-perfil__eliminar"
            (click)="eliminarRedSocial($index)"
            [attr.aria-label]="'Eliminar tu enlace de ' + getRedSocialControl($index, 'plataforma').value + ' del perfil'">
            <app-icono nombre="x" />
          </button>
        </article>
      }

      @if (redesSocialesArray.length === 0) {
        <p class="formulario-perfil__vacio">No hay redes sociales añadidas</p>
      }

      <app-boton
        tipo="button"
        variante="secondary"
        ariaLabel="Añadir una nueva red social a tu perfil"
        (click)="agregarRedSocial()">
        <app-icono nombre="plus" />
        Añadir red social
      </app-boton>
    </section>
  </fieldset>

  <footer class="formulario-perfil__acciones">
    <app-boton
      tipo="button"
      variante="secondary"
      ariaLabel="Cancelar edición del perfil y descartar los cambios"
      (click)="onCancelar()">
      Cancelar
    </app-boton>
    <app-boton
      tipo="submit"
      ariaLabel="Guardar todos los cambios de tu perfil">
      Guardar cambios
    </app-boton>
  </footer>
</form>
