@if (cargando()) {
  <main class="gimnasio gimnasio--cargando">
    <section class="gimnasio__carga">
      <app-icono nombre="loader" tamano="2xl" class="gimnasio__spinner" />
      <p class="gimnasio__carga-texto">Cargando información del gimnasio...</p>
    </section>
  </main>
} @else if (gimnasio()) {
  <main class="gimnasio">
    <article class="gimnasio__contenedor">
      <!-- HEADER: Título y valoración -->
      <header class="gimnasio__header">
        <hgroup class="gimnasio__titulos">
          <h1 class="gimnasio__titulo">{{ gimnasio()!.nombre }}</h1>
          @if (gimnasio()!.valoracionMedia !== null) {
            <p class="gimnasio__valoracion">
              {{ formatearValoracion() }}
              <app-icono nombre="star" tamano="xs" class="gimnasio__estrella" />
            </p>
          }
        </hgroup>
        <button type="button" class="gimnasio__boton-resenia" (click)="abrirResenia()">
          Dejar reseña
        </button>
      </header>

      <!-- GALERÍA DE IMÁGENES -->
      @if (tieneFotos()) {
        <app-galeria 
          [imagenes]="fotosGaleria()" 
          [alt]="gimnasio()!.nombre"
          [caption]="'Galería de ' + gimnasio()!.nombre"
          [descripciones]="descripcionesGaleria()"
        />
      } @else if (gimnasio()!.foto) {
        <figure class="gimnasio__imagen-unica">
          <img 
            [src]="gimnasio()!.foto" 
            [alt]="gimnasio()!.nombre" 
            class="gimnasio__foto" 
            loading="eager"
            fetchpriority="high"
            width="800"
            height="450"
            decoding="async" />
        </figure>
      }

      <!-- DESCRIPCIÓN -->
      <section class="gimnasio__descripcion">
        <p class="gimnasio__descripcion-texto">{{ gimnasio()!.descripcion }}</p>
      </section>

      <!-- CONTENIDO PRINCIPAL -->
      <section class="gimnasio__contenido">
        <!-- PROFESORES -->
        @if (gimnasio()!.profesores && gimnasio()!.profesores.length > 0) {
          <app-seccion-lista 
            titulo="Profesores y artes marciales:" 
            [mostrarVerMas]="gimnasio()!.profesores.length > 3"
            (verMas)="verMasProfesores()"
          >
            <ul class="gimnasio__lista-profesores">
              @for (profesor of profesoresVisibles(); track trackByProfesorId($index, profesor)) {
                <li>
                  <app-tarjeta-profesor
                    [nombre]="profesor.nombre"
                    [especialidad]="profesor.especialidad"
                    [foto]="profesor.foto"
                    [proximaClase]="profesor.proximaClase ?? ''"
                    [reservada]="clasesReservadasIds().has(obtenerClaseIdProfesor(profesor))"
                    (reservar)="reservarClaseProfesor(profesor)"
                  />
                </li>
              }
            </ul>
          </app-seccion-lista>
        }

        <!-- TORNEOS -->
        @if (gimnasio()!.torneos && gimnasio()!.torneos.length > 0) {
          <app-seccion-lista 
            titulo="Torneos disponibles en {{ gimnasio()!.nombre }}:" 
            [mostrarVerMas]="gimnasio()!.torneos.length > 3"
            (verMas)="verMasTorneos()"
          >
            <ul class="gimnasio__lista-torneos">
              @for (torneo of torneosVisibles(); track trackByTorneoId($index, torneo)) {
                <li>
                  <app-item-torneo
                    [nombre]="torneo.nombre"
                    [fecha]="torneo.fecha"
                    [disciplina]="torneo.disciplina"
                  />
                </li>
              }
            </ul>
          </app-seccion-lista>
        }

        <!-- RESEÑAS -->
        @if (gimnasio()!.resenias && gimnasio()!.resenias.length > 0) {
          <app-seccion-lista 
            titulo="Reseñas de otros alumnos:" 
            [mostrarVerMas]="gimnasio()!.resenias.length > 3"
            (verMas)="verMasResenias()"
          >
            <ul class="gimnasio__lista-resenias">
              @for (resenia of reseniasVisibles(); track trackByReseniaId($index, resenia)) {
                <li>
                  <app-tarjeta-resenia
                    [nombre]="resenia.nombreUsuario"
                    [texto]="resenia.texto"
                    [foto]="resenia.avatarUsuario"
                    [valoracion]="resenia.valoracion"
                    [mostrarCorazon]="true"
                  />
                </li>
              }
            </ul>
          </app-seccion-lista>
        }
      </section>
    </article>

    <!-- MODAL RESERVA -->
    @if (mostrarModalReserva()) {
      <app-modal-reserva
        [claseNombre]="claseSeleccionada()!.nombre"
        [profesorNombre]="claseSeleccionada()!.profesorNombre"
        [diasSemana]="claseSeleccionada()!.diasSemana ?? ''"
        [horaInicio]="claseSeleccionada()!.horaInicio ?? ''"
        [horaFin]="claseSeleccionada()!.horaFin ?? ''"
        (confirmar)="confirmarReserva($event)"
        (cancelar)="cerrarModalReserva()"
      />
    }

    <!-- MODAL RESEÑA -->
    @if (mostrarModalResenia()) {
      <app-modal-resenia
        [gimnasioId]="gimnasio()!.id"
        [gimnasioNombre]="gimnasio()!.nombre"
        (enviada)="onReseniaEnviada()"
        (cerrar)="cerrarModalResenia()"
      />
    }
  </main>
} @else {
  <main class="gimnasio gimnasio--error">
    <section class="gimnasio__estado-error">
      <app-icono nombre="x-circle" tamano="2xl" class="gimnasio__error-icono" />
      <h1 class="gimnasio__error-titulo">Gimnasio no encontrado</h1>
      <p class="gimnasio__error-texto">El gimnasio que buscas no existe o ha sido eliminado.</p>
    </section>
  </main>
}

