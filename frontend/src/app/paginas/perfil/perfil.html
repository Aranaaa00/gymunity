<section class="perfil" role="main" aria-labelledby="perfil-titulo">
  <header class="perfil__cabecera" tabindex="0" [attr.aria-label]="'Perfil de ' + (usuario()?.nombreUsuario ?? 'Usuario') + ', ' + rolFormateado() + ' en ' + ciudad() + '. Tienes ' + creditosTexto() + ' créditos disponibles'">
    <figure class="perfil__avatar" aria-hidden="true">
      @if (usuario()?.avatar) {
        <img [src]="usuario()!.avatar" [alt]="'Tu foto de perfil, ' + usuario()!.nombreUsuario" class="perfil__avatar-img" width="128" height="128" loading="eager" fetchpriority="high" decoding="async" />
      } @else {
        <app-icono nombre="user" tamano="2xl" class="perfil__avatar-icono" />
      }
    </figure>

    <hgroup class="perfil__info" aria-hidden="true">
      <h1 id="perfil-titulo" class="perfil__nombre">{{ usuario()?.nombreUsuario ?? 'Usuario' }}</h1>
      <p class="perfil__rol">{{ rolFormateado() }}</p>
      <p class="perfil__ubicacion">
        <app-icono nombre="map-pin" tamano="xs" />
        {{ ciudad() }}
      </p>
    </hgroup>

    <aside class="perfil__acciones">
      <span class="perfil__creditos" aria-hidden="true">
        <strong class="perfil__creditos-valor">{{ creditosTexto() }}</strong>
        <span class="perfil__creditos-texto">créditos</span>
      </span>
      <button type="button" class="perfil__btn-editar" (click)="irAConfiguracion()" aria-label="Ir a configuración para editar tu perfil">
        <app-icono nombre="settings" tamano="sm" aria-hidden="true" />
        Editar perfil
      </button>
    </aside>
  </header>

  <app-tabs [pestanas]="pestanas" [tabActivo]="tabActivo()" (tabCambiado)="cambiarTab($event)">
    @switch (tabActivo()) {
      @case (0) {
        <article class="perfil__logros" role="region" aria-label="Tus logros y medallas">
          @for (categoria of categorias; track categoria) {
            <section class="perfil__categoria" role="region" [attr.aria-label]="'Categoría ' + categoria">
              <h3 class="perfil__categoria-titulo" tabindex="0">{{ categoria }}</h3>
              <ul class="perfil__lista-logros" role="list">
                @for (logro of logrosPorCategoria().get(categoria); track logro.id) {
                  <li 
                    class="perfil__logro" 
                    [class.perfil__logro--desbloqueado]="logro.desbloqueado"
                    tabindex="0"
                    [attr.aria-label]="logro.nombre + (logro.desbloqueado ? ', logro conseguido' : ', logro bloqueado')">
                    <span class="perfil__logro-icono" aria-hidden="true">
                      <app-icono [nombre]="obtenerIconoLogro(logro)" tamano="sm" />
                    </span>
                    <span class="perfil__logro-nombre" aria-hidden="true">{{ logro.nombre }}</span>
                  </li>
                }
              </ul>
            </section>
          }
        </article>
      }
      @case (1) {
        @if (cargando()) {
          <article class="perfil__cargando">
            <app-icono nombre="loader" tamano="xl" class="perfil__spinner" />
          </article>
        } @else if (clases().length === 0) {
          <article class="perfil__vacio">
            <app-icono nombre="calendar" tamano="2xl" class="perfil__vacio-icono" />
            <p class="perfil__vacio-texto">No tienes clases reservadas</p>
            <p class="perfil__vacio-subtexto">Explora gimnasios y reserva tu primera clase</p>
          </article>
        } @else {
          <ul class="perfil__lista-clases">
            @for (clase of clasesPaginadas(); track clase.id) {
              <li 
                class="perfil__clase" 
                role="button" 
                tabindex="0" 
                [attr.aria-label]="'Ver gimnasio ' + clase.gimnasio + ', clase de ' + clase.nombre + ' con ' + clase.profesor"
                (click)="irAGimnasio(clase)" 
                (keydown.enter)="irAGimnasio(clase)"
                (keydown.space)="irAGimnasio(clase); $event.preventDefault()"
              >
                <figure class="perfil__clase-avatar">
                  <app-icono [nombre]="obtenerIconoClase(clase.nombre)" tamano="lg" />
                </figure>
                <hgroup class="perfil__clase-info">
                  <h4 class="perfil__clase-nombre">{{ clase.nombre }}</h4>
                  <p class="perfil__clase-gimnasio">
                    <app-icono nombre="map-pin" tamano="xs" />
                    {{ clase.gimnasio }}
                  </p>
                  <p class="perfil__clase-profesor">
                    <app-icono nombre="user" tamano="xs" />
                    {{ clase.profesor }}
                  </p>
                  <time class="perfil__clase-fecha">
                    <app-icono nombre="calendar" tamano="xs" />
                    {{ formatearFecha(clase.fechaClase) }}
                  </time>
                </hgroup>
                <aside class="perfil__clase-acciones">
                  @if (esCompletada(clase)) {
                    <mark class="perfil__clase-estado perfil__clase-estado--completada">
                      <app-icono nombre="check-circle" tamano="sm" />
                      Completada
                    </mark>
                  } @else {
                    <mark class="perfil__clase-estado perfil__clase-estado--pendiente">
                      <app-icono nombre="clock" tamano="sm" />
                      Pendiente
                    </mark>
                    @if (puedeCancelar(clase)) {
                      <button 
                        type="button" 
                        class="perfil__btn-cancelar"
                        [class.perfil__btn-cancelar--sin-reembolso]="!clase.puedeReembolsar"
                        [attr.aria-label]="clase.puedeReembolsar ? 'Cancelar clase de ' + clase.nombre + ' en ' + clase.gimnasio + ' y recuperar tu crédito' : 'Cancelar clase de ' + clase.nombre + ' sin reembolso porque quedan menos de 24 horas'"
                        (click)="cancelarClase(clase); $event.stopPropagation()"
                        [title]="clase.puedeReembolsar ? 'Cancelar y recuperar crédito' : 'Cancelar sin reembolso (menos de 24h)'"
                      >
                        <app-icono nombre="x-circle" tamano="sm" />
                        {{ clase.puedeReembolsar ? 'Cancelar' : 'Cancelar (sin reembolso)' }}
                      </button>
                    }
                  }
                </aside>
              </li>
            }
          </ul>
          @if (mostrarPaginacion()) {
            <app-paginacion
              [paginaActual]="paginaClases()"
              [totalPaginas]="totalPaginasClases()"
              ariaLabel="Paginación de clases"
              (anterior)="paginaAnterior()"
              (siguiente)="paginaSiguiente()"
            />
          }
        }
      }
      @case (2) {
        @if (resenias().length === 0) {
          <article class="perfil__vacio">
            <app-icono nombre="message-circle" tamano="2xl" class="perfil__vacio-icono" />
            <p class="perfil__vacio-texto">Aún no has escrito reseñas</p>
            <p class="perfil__vacio-subtexto">Comparte tu experiencia con otros alumnos</p>
          </article>
        } @else {
          <ul class="perfil__timeline-resenias">
            @for (resenia of reseniasPaginadas(); track resenia.id; let i = $index) {
              <li class="perfil__resenia-item" [class.perfil__resenia-item--par]="i % 2 === 0">
                <aside class="perfil__resenia-punto">
                  <span class="perfil__resenia-circulo"></span>
                </aside>
                <article class="perfil__resenia-card">
                  <header class="perfil__resenia-header">
                    <h4 class="perfil__resenia-gimnasio">{{ resenia.gimnasioNombre }}</h4>
                    <span class="perfil__resenia-valoracion">
                      @for (star of [1,2,3,4,5]; track star) {
                        <app-icono 
                          nombre="star" 
                          tamano="xs" 
                          [class.perfil__resenia-estrella--activa]="star <= resenia.valoracion"
                          class="perfil__resenia-estrella"
                        />
                      }
                    </span>
                  </header>
                  <p class="perfil__resenia-texto">{{ resenia.texto }}</p>
                  <footer class="perfil__resenia-footer">
                    <time class="perfil__resenia-fecha">
                      <app-icono nombre="calendar" tamano="xs" />
                      {{ formatearFecha(resenia.fecha) }}
                    </time>
                  </footer>
                </article>
              </li>
            }
          </ul>
          @if (mostrarPaginacionResenias()) {
            <app-paginacion
              [paginaActual]="paginaResenias()"
              [totalPaginas]="totalPaginasResenias()"
              ariaLabel="Paginación de reseñas"
              (anterior)="paginaAnteriorResenias()"
              (siguiente)="paginaSiguienteResenias()"
            />
          }
        }
      }
    }
  </app-tabs>
</section>
