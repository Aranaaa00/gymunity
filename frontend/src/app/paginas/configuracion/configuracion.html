<main class="ajustes" role="main" aria-labelledby="titulo-ajustes">
  <header class="ajustes__cabecera">
    <h1 id="titulo-ajustes" class="ajustes__titulo">Ajustes</h1>
    <button 
      type="button" 
      class="ajustes__salir" 
      (click)="cerrarSesion()"
      aria-label="Cerrar sesion y salir de la aplicacion">
      <app-icono nombre="log-out" tamano="sm" aria-hidden="true" />
      <span>Cerrar sesi√≥n</span>
    </button>
  </header>

  <!-- ================================== -->
  <!-- SECCION: FOTO DE PERFIL -->
  <!-- ================================== -->
  <section class="ajustes__seccion" aria-labelledby="titulo-foto">
    <div class="ajustes__seccion-icono" aria-hidden="true">
      <app-icono nombre="camera" tamano="md" />
    </div>
    <div class="ajustes__seccion-contenido">
      <h2 id="titulo-foto" class="ajustes__seccion-titulo">Foto de perfil</h2>
      <p class="ajustes__seccion-desc">Tu imagen visible para otros usuarios</p>
      
      <div class="ajustes__avatar-zona">
        <button 
          type="button"
          class="ajustes__avatar"
          (click)="inputAvatar.click()"
          [attr.aria-label]="tieneAvatar() ? 'Cambiar foto de perfil actual' : 'Subir foto de perfil'">
          @if (avatarActual()) {
            <img [src]="avatarActual()" alt="Tu foto de perfil actual" class="ajustes__avatar-img" width="96" height="96" loading="eager" fetchpriority="high" decoding="async" />
          } @else {
            <app-icono nombre="user" tamano="xl" aria-hidden="true" />
          }
          <span class="ajustes__avatar-overlay" aria-hidden="true">
            <app-icono nombre="camera" tamano="sm" />
            Cambiar
          </span>
        </button>
        <input 
          #inputAvatar
          type="file"
          accept="image/jpeg,image/png,image/webp"
          class="ajustes__avatar-input"
          aria-label="Seleccionar archivo de imagen"
          (change)="onFileSelected($event)"
        />
        <div class="ajustes__avatar-info">
          <span class="ajustes__avatar-formato">JPG, PNG o WebP</span>
          <span class="ajustes__avatar-size">Se optimiza automaticamente</span>
        </div>
      </div>

      @if (puedeGuardarAvatar()) {
        <app-boton 
          variante="primary"
          tamano="sm"
          [cargando]="guardandoAvatar()"
          (click)="guardarAvatar()"
          aria-label="Guardar nueva foto de perfil">
          Guardar foto
        </app-boton>
      }
    </div>
  </section>

  <!-- ================================== -->
  <!-- SECCION: DATOS PERSONALES -->
  <!-- ================================== -->
  <section class="ajustes__seccion" aria-labelledby="titulo-datos">
    <div class="ajustes__seccion-icono" aria-hidden="true">
      <app-icono nombre="user" tamano="md" />
    </div>
    <div class="ajustes__seccion-contenido">
      <h2 id="titulo-datos" class="ajustes__seccion-titulo">Datos personales</h2>
      <p class="ajustes__seccion-desc">Informacion basica de tu cuenta</p>
      
      <form 
        class="ajustes__form" 
        [formGroup]="perfilForm" 
        (ngSubmit)="guardarPerfil()"
        aria-label="Formulario de datos personales">
        
        <app-campo-formulario
          label="Nombre de usuario"
          type="text"
          placeholder="Tu identificador unico"
          inputId="config-username"
          name="username"
          autocomplete="username"
          [formControl]="usernameControl"
          [required]="false"
          [validando]="estaValidando('username')"
          [hasError]="usernameControl.touched && usernameControl.invalid"
          [errorMessage]="getErrorPerfil('username')"
          [mensajeExito]="getMensajeExitoPerfil('username')" />

        <app-campo-formulario
          label="Email"
          type="email"
          placeholder="tu@email.com"
          inputId="config-email"
          name="email"
          autocomplete="email"
          [formControl]="emailControl"
          [required]="false"
          [validando]="estaValidando('email')"
          [hasError]="emailControl.touched && emailControl.invalid"
          [errorMessage]="getErrorPerfil('email')"
          [mensajeExito]="getMensajeExitoPerfil('email')" />

        <app-campo-formulario
          label="Ciudad"
          type="text"
          placeholder="Donde entrenas habitualmente"
          inputId="config-ciudad"
          name="ciudad"
          autocomplete="address-level2"
          [formControl]="ciudadControl"
          [required]="false"
          [validando]="estaValidando('ciudad')"
          [hasError]="ciudadControl.touched && ciudadControl.invalid"
          [errorMessage]="getErrorPerfil('ciudad')"
          [mensajeExito]="getMensajeExitoPerfil('ciudad')" />

        <app-boton 
          tipo="submit"
          variante="primary"
          [cargando]="guardandoPerfil()"
          aria-label="Guardar cambios en datos personales">
          Guardar cambios
        </app-boton>
      </form>
    </div>
  </section>

  <!-- ================================== -->
  <!-- SECCION: SEGURIDAD -->
  <!-- ================================== -->
  <section class="ajustes__seccion" aria-labelledby="titulo-seguridad">
    <div class="ajustes__seccion-icono" aria-hidden="true">
      <app-icono nombre="shield" tamano="md" />
    </div>
    <div class="ajustes__seccion-contenido">
      <h2 id="titulo-seguridad" class="ajustes__seccion-titulo">Seguridad</h2>
      <p class="ajustes__seccion-desc">Cambia tu contrasena periodicamente</p>
      
      <form 
        class="ajustes__form" 
        [formGroup]="passwordForm" 
        (ngSubmit)="cambiarContrasenia()"
        aria-label="Formulario de cambio de contrasena">
        
        <app-campo-formulario
          label="Contrasena actual"
          type="password"
          placeholder="Tu contrasena actual"
          inputId="config-password-actual"
          name="contraseniaActual"
          autocomplete="current-password"
          [formControl]="contraseniaActualControl"
          [required]="true"
          [hasError]="contraseniaActualControl.touched && contraseniaActualControl.invalid"
          [errorMessage]="getErrorPassword('contraseniaActual')" />

        <article class="ajustes__password-grupo">
          <app-campo-formulario
            label="Nueva contrasena"
            type="password"
            placeholder="Minimo 6 caracteres"
            inputId="config-password-nueva"
            name="contraseniaNueva"
            autocomplete="new-password"
            [formControl]="contraseniaNuevaControl"
            [required]="true"
            [hasError]="contraseniaNuevaControl.touched && contraseniaNuevaControl.invalid"
            [errorMessage]="getErrorPassword('contraseniaNueva')" />

          @if (contraseniaNuevaControl.value) {
            <section class="ajustes__fuerza">
              <figure class="ajustes__fuerza-barra">
                <span 
                  class="ajustes__fuerza-progreso"
                  [class.ajustes__fuerza-progreso--debil]="fuerzaPassword().nivel === 'debil'"
                  [class.ajustes__fuerza-progreso--media]="fuerzaPassword().nivel === 'media'"
                  [class.ajustes__fuerza-progreso--fuerte]="fuerzaPassword().nivel === 'fuerte'"
                  [class.ajustes__fuerza-progreso--muy-fuerte]="fuerzaPassword().nivel === 'muy-fuerte'"
                  [style.width.%]="fuerzaPassword().porcentaje">
                </span>
              </figure>
              <small class="ajustes__fuerza-mensaje">{{ fuerzaPassword().mensaje }}</small>
            </section>
          }
        </article>

        <article class="ajustes__password-grupo">
          <app-campo-formulario
            label="Repetir contrasena"
            type="password"
            placeholder="Repite la nueva contrasena"
            inputId="config-password-confirmar"
            name="confirmarContrasenia"
            autocomplete="new-password"
            [formControl]="confirmarContraseniaControl"
            [required]="true"
            [hasError]="confirmarContraseniaControl.touched && !contraseniasCoinciden()"
            [errorMessage]="getErrorPassword('confirmarContrasenia')"
            [mensajeExito]="getMensajeCoincidencia()" />
        </article>

        <app-boton 
          tipo="submit"
          variante="primary"
          [disabled]="!puedeGuardarPassword()"
          [cargando]="guardandoPassword()"
          aria-label="Guardar nueva contrasena">
          Cambiar contrasena
        </app-boton>
      </form>
    </div>
  </section>

  <!-- ================================== -->
  <!-- SECCION: ELIMINAR CUENTA -->
  <!-- ================================== -->
  <section class="ajustes__seccion ajustes__seccion--eliminar" aria-labelledby="titulo-eliminar">
    <div class="ajustes__seccion-icono ajustes__seccion-icono--muted" aria-hidden="true">
      <app-icono nombre="trash" tamano="md" />
    </div>
    <div class="ajustes__seccion-contenido">
      <h2 id="titulo-eliminar" class="ajustes__seccion-titulo">Eliminar cuenta</h2>
      <p class="ajustes__seccion-desc">Esta accion es permanente y no se puede deshacer</p>
      
      @if (!mostrarConfirmacionEliminar()) {
        <button 
          type="button" 
          class="ajustes__btn-eliminar"
          (click)="toggleConfirmacionEliminar()"
          aria-expanded="false"
          aria-controls="confirmacion-eliminar">
          Quiero eliminar mi cuenta
        </button>
      } @else {
        <div id="confirmacion-eliminar" class="ajustes__confirmar" role="alertdialog" aria-labelledby="confirmar-titulo">
          <p id="confirmar-titulo" class="ajustes__confirmar-texto">
            Escribe <strong>{{ textoConfirmacion() }}</strong> para confirmar
          </p>
          <input 
            #inputConfirmacion
            type="text"
            class="ajustes__confirmar-input"
            placeholder="Tu nombre de usuario"
            autocomplete="off"
            aria-label="Confirmar nombre de usuario para eliminar cuenta"
            aria-describedby="confirmar-titulo"
          />
          @if (errorEliminar()) {
            <p class="ajustes__mensaje ajustes__mensaje--error" role="alert">{{ errorEliminar() }}</p>
          }
          <div class="ajustes__confirmar-btns">
            <button 
              type="button" 
              class="ajustes__btn-cancelar"
              (click)="toggleConfirmacionEliminar()"
              aria-label="Cancelar eliminacion de cuenta">
              Cancelar
            </button>
            <app-boton 
              variante="primary"
              tamano="sm"
              (click)="confirmarEliminacion(inputConfirmacion)"
              [cargando]="cargando()"
              aria-label="Confirmar eliminacion permanente de cuenta">
              Eliminar definitivamente
            </app-boton>
          </div>
        </div>
      }
    </div>
  </section>
</main>
